# Block ‚Äì Repository Architecture Overview

This document explains the initial Block monorepo structure so Jamie, Aaron, and Stephen fully understand how the system works during Sprint 1.

## üìÅ Root Repository Structure
BLOCK/
  api/           ‚Üê Backend (NestJS + Prisma + Clustering Engine)
  app/           ‚Üê Frontend (Next.js App Router on Vercel)
  public/        ‚Üê Static assets
  types/         ‚Üê Shared TypeScript interfaces

  package.json
  package-lock.json
  tsconfig.json
  next.config.ts
  eslint.config.mjs
  postcss.config.mjs
  .gitignore
  README.md
  ARCHITECTURE.md

## /app ‚Äì Frontend (Next.js on Vercel)

The frontend contains the Rep App and Manager Dashboard.
This is Jamie‚Äôs primary responsibility.

Typical Structure
app/
  layout.tsx
  page.tsx

  rep/
    layout.tsx
    page.tsx
    house/[id]/page.tsx

  manager/
    layout.tsx
    dashboard/page.tsx
    clusters/page.tsx
    routes/page.tsx

Responsibilities

Map UI using Mapbox

Rep workflow (route view, house status updates)

Manager dashboard (clusters, performance views)

Fetching data from backend (/api)

## /api ‚Äì Backend (NestJS + Prisma + Clustering Engine)

This contains the REST API, database layer, and clustering/routing engine.
This is Stephen‚Äôs and Aaron‚Äôs responsibility.

Structure
api/
  prisma/
    schema.prisma
    migrations/

  src/
    main.ts
    app.module.ts

    core/
      config/
      database/
      common/

    modules/
      auth/
      users/
      companies/
      houses/
      clusters/
      routes/
      visits/
      clustering/

### /api/prisma ‚Äì Database Configuration

schema.prisma ‚Äî database models for Prisma + Supabase

migrations/ ‚Äî SQL migration history generated by Prisma

Used for:

Storing houses

Storing clusters

Storing routes

Multi-tenant data (companyId on all models)

### /api/src ‚Äì Backend Source Code
main.ts

Entry point of the backend application.
Starts the NestJS server and loads modules.

app.module.ts

Root module that imports all domain modules:

auth

houses

clusters

routes

visits

clustering

### /api/src/core ‚Äì Shared Infrastructure
config/

Loads environment variables

Provides global configuration services

database/

prisma.service.ts ‚Äî Prisma client wrapped for NestJS

database.module.ts ‚Äî makes Prisma injectable across modules

common/

Shared utilities:

DTO base classes

Guards (e.g., JWT guard)

Pipes

Interceptors

Exception filters

### /api/src/modules ‚Äì Main Logic & Domain Modules

Each of these directories contains:

A module (*.module.ts)

A controller (*.controller.ts)

A service (*.service.ts)

Optional DTOs

auth/

Login, user sessions, token verification.

users/

CRUD on user accounts.

companies/

Tenant management (multi-company support).

houses/

Store house coordinates

Update visit statuses

Import house lists

Query houses by cluster

clusters/

Fetch cluster summaries

Show cluster ‚Üí house relationships

routes/

Fetch optimized routes

Return ordered walking paths

visits/

Logging rep activity

Visit history for analytics

### /api/src/modules/clustering ‚Äì Clustering Engine (Aaron)

This is where Block‚Äôs intelligence lives.

clustering/
  clustering.module.ts
  clustering.service.ts
  dbscan.ts
  tsp.ts

dbscan.ts

Implements the DBSCAN clustering algorithm (or wraps density-clustering).

tsp.ts

Route optimization for each cluster:

nearest neighbor

2-opt improvement

clustering.service.ts

Orchestrates the full process:

Fetch houses

Run clustering

Generate routes

Save clusters & routes in database

## /types ‚Äì Shared Types

Interfaces shared across frontend and backend to keep API responses identical.

Example:

export interface HouseDTO {
  id: string;
  address: string;
  lat: number;
  lng: number;
  status: string;
  clusterId?: string | null;
}

## Sprint 1 ‚Äì Required NPM Dependencies

Everyone must install dependencies in the correct folders.

### Frontend Dependencies (/app)
npm install next react react-dom
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
npm install mapbox-gl
npm install @tanstack/react-query
npm install axios
npm install clsx
npm install -D eslint prettier

### Backend Dependencies (/api)
npm install @nestjs/common @nestjs/core @nestjs/platform-express
npm install -D @nestjs/cli @nestjs/schematics @nestjs/testing
npm install class-validator class-transformer
npm install cors
npm install dotenv
npm install axios

### Prisma + Database (/api)
npm install -D prisma
npm install @prisma/client
npx prisma init


Enable PostGIS in Supabase:

create extension if not exists postgis;

### Clustering Engine Dependencies (/api)
npm install @turf/turf
npm install density-clustering
npm install geolib

### Shared / Dev Tools
npm install -D typescript ts-node ts-node-dev
npm install -D nodemon
npm install -g turbo
npm install -D eslint prettier eslint-config-prettier eslint-plugin-prettier

## Team Responsibilities Summary
Jamie ‚Äî UI Lead

Build Rep App & Manager Dashboard

Implement Mapbox

Consume backend API

Styling & layout

Aaron ‚Äî Clustering Lead

Implement DBSCAN and routing algorithms

Handle cluster/route generation in backend

Support backend integration logic

Stephen ‚Äî Backend Lead

Build NestJS API

Define Prisma models

Connect Supabase database

Integrate clustering + frontend

Ensure multi-tenant structure

## Development Flow

Frontend calls API ‚Üí /api

Backend fetches houses ‚Üí Prisma

Clustering Engine generates clusters/routes

Database stores results

Frontend renders them via Mapbox