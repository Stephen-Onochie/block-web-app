// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = process.env.DATABASE_URL;
}

enum Role {
  REP
  MANAGER
  ADMIN
}

enum HouseStatus {
  NOT_VISITED
  KNOCKED
  INTERESTED
  NOT_INTERESTED
  SOLD
}

model Company {
  id String @id @default(uuid()) @db.uuid
  name String

  createdAt DateTime @default (now())
  updatedAt DatTime @updatedAt

  users User[]
  houses House[]
  clusters Cluster[]
  routes Route[]
  visits Visit[]
}

model User {
  id String @id @default(uuid()) @db.uuid
  email String @unique
  name String?
  role Role @default(REP)

  companyId String @db.uuid
  company company @relation(fields: [companyId], references: [id])

  visits Visit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model House {
  id        String   @id @default(uuid()) @db.Uuid

  companyId String   @db.Uuid
  company   Company  @relation(fields: [companyId], references: [id])

  address   String
  city      String?
  state     String?
  zip       String?

  lat       Float
  lng       Float

  status    HouseStatus @default(NOT_VISITED)

  clusterId String?  @db.Uuid
  cluster   Cluster? @relation(fields: [clusterId], references: [id])

  // stops for routes that include this house
  routeStops RouteStop[]
  visits     Visit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional: PostGIS geometry column if you want to add later
  // location Unsupported("geometry")?
}

model Cluster {
  id        String   @id @default(uuid()) @db.Uuid

  companyId String   @db.Uuid
  company   Company  @relation(fields: [companyId], references: [id])

  name      String?  // optional label like "Block A"

  centerLat Float
  centerLng Float

  // Optionally store polygon boundary via PostGIS later:
  // boundary Unsupported("geometry")?

  houses   House[]
  routes   Route[]

  createdAt DateTime @default(now())
}

model Route {
  id        String   @id @default(uuid()) @db.Uuid

  companyId String   @db.Uuid
  company   Company  @relation(fields: [companyId], references: [id])

  clusterId String   @db.Uuid
  cluster   Cluster  @relation(fields: [clusterId], references: [id])

  name      String?   // e.g. "Morning Route"
  date      DateTime? // scheduled date/time if needed

  totalDistanceMeters  Int?
  totalDurationSeconds Int?

  stops    RouteStop[]
  visits   Visit[]

  createdAt DateTime @default(now())
}

model RouteStop {
  id      String @id @default(uuid()) @db.Uuid

  routeId String @db.Uuid
  route   Route  @relation(fields: [routeId], references: [id], onDelete: Cascade)

  houseId String @db.Uuid
  house   House  @relation(fields: [houseId], references: [id])

  order   Int    // 0, 1, 2, ... (sequence in the route)
}

model Visit {
  id        String   @id @default(uuid()) @db.Uuid

  companyId String   @db.Uuid
  company   Company  @relation(fields: [companyId], references: [id])

  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])

  houseId   String   @db.Uuid
  house     House    @relation(fields: [houseId], references: [id])

  routeId   String?  @db.Uuid
  route     Route?   @relation(fields: [routeId], references: [id])

  oldStatus HouseStatus?
  newStatus HouseStatus

  note      String?

  createdAt DateTime @default(now())
}

